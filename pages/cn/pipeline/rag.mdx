---
title: "Vanilla RAG"
icon: "ice-cream"
---

<Note>æˆ‘ä»¬ä¸ºè¯¥ Demo å½•åˆ¶äº†ä¸€æœŸè®²è§£è§†é¢‘ï¼š[ğŸ“º bilibili](https://www.bilibili.com/video/BV1B9apz4E7K/?share_source=copy_web&vd_source=7035ae721e76c8149fb74ea7a2432710)ã€‚</Note>
## ä»€ä¹ˆæ˜¯RAGï¼Ÿ

> æƒ³è±¡ä½ åœ¨å‚åŠ ä¸€æ¬¡å¼€å·è€ƒè¯•ã€‚ä½ æœ¬äººå°±æ˜¯å¤§è¯­è¨€æ¨¡å‹ï¼Œå…·å¤‡ç†è§£é¢˜ç›®å’Œå†™ç­”æ¡ˆçš„èƒ½åŠ›ã€‚  
> ä½†ä½ ä¸å¯èƒ½è®°ä½æ‰€æœ‰çŸ¥è¯†ç‚¹ã€‚è¿™æ—¶ï¼Œå…è®¸ä½ å¸¦ä¸€æœ¬æ•™ææˆ–å‚è€ƒä¹¦è¿›è€ƒåœºâ€”â€”è¿™å°±æ˜¯æ£€ç´¢ã€‚  
> å½“ä½ ç¿»ä¹¦æ‰¾åˆ°ç›¸å…³å†…å®¹ï¼Œå†ç»“åˆè‡ªå·±çš„ç†è§£å»å†™ç­”æ¡ˆï¼Œè¿™æ ·ç­”æ¡ˆæ—¢å‡†ç¡®åˆæœ‰æ ¹æ®ã€‚  
> è¿™å°±æ˜¯ RAG â€”â€” æ£€ç´¢å¢å¼ºç”Ÿæˆã€‚

RAGï¼ˆRetrieval-Augmented Generationï¼Œæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æ˜¯ä¸€ç§è®©å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰åœ¨â€œç”Ÿæˆâ€ä¹‹å‰ï¼Œå…ˆå»â€œæ£€ç´¢â€ç›¸å…³æ–‡æ¡£æˆ–çŸ¥è¯†åº“ï¼Œå†ç»“åˆè¿™äº›ä¿¡æ¯ç”Ÿæˆå›ç­”çš„æŠ€æœ¯ã€‚

### æµç¨‹

**æ£€ç´¢é˜¶æ®µ**ï¼šæ ¹æ®ç”¨æˆ·é—®é¢˜ï¼Œä»æ–‡æ¡£åº“ä¸­æ‰¾åˆ°æœ€ç›¸å…³çš„å†…å®¹ï¼ˆæ¯”å¦‚çŸ¥è¯†åº“ã€ç½‘é¡µç­‰ï¼‰ï¼›  
![](/images/pipeline/rag/retrieve_stage.png)

**ç”Ÿæˆé˜¶æ®µ**ï¼šæŠŠæ£€ç´¢åˆ°çš„å†…å®¹ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œè¾“å…¥ç»™ LLMï¼Œè®©å®ƒåŸºäºè¿™äº›ä¿¡æ¯ç”Ÿæˆå›ç­”  
![](/images/pipeline/rag/gen_stage.png)

### ä½œç”¨

- æå‡å‡†ç¡®åº¦ã€é™ä½â€œå¹»è§‰â€
- æ— éœ€é‡è®­æ¨¡å‹ï¼Œä¹Ÿèƒ½ä¿æŒæ—¶æ•ˆæ€§å’Œä¸“ä¸šæ€§
- å¢å¼ºå¯ä¿¡åº¦
  

## è¯­æ–™åº“ç¼–ç ä¸ç´¢å¼•

åœ¨ä½¿ç”¨ RAG ä¹‹å‰ï¼Œéœ€è¦å…ˆå°†åŸå§‹æ–‡æ¡£è½¬åŒ–ä¸º å‘é‡è¡¨ç¤ºï¼Œå¹¶å»ºç«‹ æ£€ç´¢ç´¢å¼•ã€‚è¿™æ ·ï¼Œå½“ç”¨æˆ·æé—®æ—¶ï¼Œç³»ç»Ÿæ‰èƒ½åœ¨å¤§è§„æ¨¡è¯­æ–™åº“ä¸­å¿«é€Ÿæ‰¾åˆ°æœ€ç›¸å…³çš„å†…å®¹ã€‚
- **ç¼–ç ï¼ˆEmbeddingï¼‰**ï¼šæŠŠè‡ªç„¶è¯­è¨€æ–‡æœ¬è½¬åŒ–ä¸ºå‘é‡ï¼Œè®©è®¡ç®—æœºå¯ä»¥ç”¨æ•°å­¦æ–¹å¼æ¯”è¾ƒè¯­ä¹‰ç›¸ä¼¼åº¦ã€‚
- **ç´¢å¼•ï¼ˆIndexingï¼‰**ï¼šæŠŠè¿™äº›å‘é‡ç»„ç»‡èµ·æ¥ï¼Œæ¯”å¦‚ç”¨ FAISSï¼Œè¿™æ ·æ£€ç´¢æ—¶æ‰èƒ½åœ¨å‡ ç™¾ä¸‡æ¡æ–‡æ¡£ä¸­ç¬é—´æ‰¾åˆ°æœ€ç›¸å…³çš„è‹¥å¹²æ¡ã€‚

![](/images/pipeline/rag/emb_index.png)

### ç¤ºä¾‹è¯­æ–™ï¼ˆWiki æ–‡æœ¬ï¼‰

```json data/corpus_example.jsonl icon="/images/json.svg"
{"id": "2066692", "contents": "Truman Sports Complex The Harry S. Truman Sports...."}
{"id": "15106858", "contents": "Arrowhead Stadium 1970s...."}
```

è¿™æ˜¯å…¸å‹çš„ Wiki è¯­æ–™ï¼Œå…¶ä¸­ id æ˜¯æ–‡æ¡£çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œcontents æ˜¯å®é™…çš„æ–‡æœ¬å†…å®¹ã€‚åç»­æˆ‘ä»¬ä¼šå¯¹ contents åšå‘é‡åŒ–å¹¶å»ºç«‹ç´¢å¼•ã€‚

### ç¼–å†™ç¼–ç ã€ç´¢å¼•Pipeline

```yaml examples/corpus_index.yaml icon="/images/yaml.svg"
# MCP Server
servers:
  retriever: servers/retriever

# MCP Client Pipeline
pipeline:
- retriever.retriever_init
- retriever.retriever_embed
- retriever.retriever_index
```
è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªæœ€å°çš„ä¸‰æ­¥æµç¨‹ï¼šåˆå§‹åŒ– â†’ ç¼–ç  â†’ å»ºç´¢å¼•ã€‚

### ç¼–è¯‘Pipelineæ–‡ä»¶

```shell
ultrarag build examples/corpus_index.yaml
```

### ä¿®æ”¹å‚æ•°æ–‡ä»¶

```yaml examples/parameters/corpus_index_parameter.yaml icon="/images/yaml.svg" 
retriever:
  backend: sentence_transformers 
  backend_configs:
    bm25:
      lang: en
    infinity:
      bettertransformer: false
      device: cuda
      model_warmup: false
      pooling_method: auto
      trust_remote_code: true
    openai:
      api_key: ''
      base_url: https://api.openai.com/v1
      model_name: text-embedding-3-small
    sentence_transformers:
      device: cuda
      sentence_transformers_encode:
        encode_chunk_size: 10000
        normalize_embeddings: false
        psg_prompt_name: document
        psg_task: null
        q_prompt_name: query
        q_task: null
      trust_remote_code: true
  batch_size: 16
  corpus_path: data/corpus_example.jsonl
  embedding_path: embedding/embedding.npy
  faiss_use_gpu: true
  gpu_ids: 0,1
  index_chunk_size: 50000
  index_path: index/index.index
  is_multimodal: false
  model_name_or_path: openbmb/MiniCPM-Embedding-Light # [!code --]
  model_name_or_path: Qwen/Qwen3-Embedding-0.6B # [!code ++]
  overwrite: false
```

### è¿è¡ŒPipelineæ–‡ä»¶

```shell
ultrarag run examples/corpus_index.yaml
```

ç¼–ç ä¸ç´¢å¼•é˜¶æ®µé€šå¸¸æ¶‰åŠå¤§è§„æ¨¡è¯­æ–™å¤„ç†ï¼Œè€—æ—¶è¾ƒé•¿ã€‚å»ºè®®ä½¿ç”¨ `screen` æˆ– `nohup` å°†ä»»åŠ¡æŒ‚è½½è‡³åå°è¿è¡Œï¼Œä¾‹å¦‚ï¼š

```shell
nohup ultrarag run examples/corpus_index.yaml > log.txt 2>&1 &
```

è¿è¡ŒæˆåŠŸåï¼Œå°±ä¼šå¾—åˆ°å¯¹åº”çš„è¯­æ–™å‘é‡å’Œç´¢å¼•æ–‡ä»¶ï¼Œåç»­ RAG Pipeline å°±å¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒä»¬æ¥å®Œæˆæ£€ç´¢ã€‚

## æ­å»ºRAG Pipeline

å½“è¯­æ–™åº“çš„ç´¢å¼•å‡†å¤‡å®Œæˆåï¼Œä¸‹ä¸€æ­¥å°±æ˜¯å°† æ£€ç´¢å™¨ å’Œ å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ ç»„åˆèµ·æ¥ï¼Œæ­å»ºä¸€ä¸ªå®Œæ•´çš„ RAG Pipelineã€‚è¿™æ ·ï¼Œé—®é¢˜å¯ä»¥ç»è¿‡æ£€ç´¢æ‰¾åˆ°ç›¸å…³æ–‡æ¡£ï¼Œå†äº¤ç”±æ¨¡å‹ç”Ÿæˆæœ€ç»ˆå›ç­”ã€‚

### æ£€ç´¢æµç¨‹

![](/images/pipeline/rag/retrieve.png)

### ç”Ÿæˆæµç¨‹

![](/images/pipeline/rag/gen_stage.png)

### æ•°æ®æ ¼å¼ï¼ˆä»¥ NQ æ•°æ®é›†ä¸ºä¾‹ï¼‰

```json data/sample_nq_10.jsonl icon="/images/json.svg"
{"id": 0, "question": "when was the last time anyone was on the moon", "golden_answers": ["14 December 1972 UTC", "December 1972"], "meta_data": {}}
{"id": 1, "question": "who wrote he ain't heavy he's my brother lyrics", "golden_answers": ["Bobby Scott", "Bob Russell"], "meta_data": {}}
{"id": 2, "question": "how many seasons of the bastard executioner are there", "golden_answers": ["one", "one season"], "meta_data": {}}
{"id": 3, "question": "when did the eagles win last super bowl", "golden_answers": ["2017"], "meta_data": {}}
{"id": 4, "question": "who won last year's ncaa women's basketball", "golden_answers": ["South Carolina"], "meta_data": {}}
```
æ¯æ¡æ ·æœ¬åŒ…å«é—®é¢˜ã€æ ‡å‡†ç­”æ¡ˆï¼ˆgolden_answersï¼‰å’Œé™„åŠ ä¿¡æ¯ï¼ˆmeta_dataï¼‰ï¼Œåç»­ä¼šä½œä¸ºè¾“å…¥ä¸è¯„æµ‹åŸºå‡†ã€‚

### ç¼–å†™RAG Pipeline

```yaml examples/rag.yaml icon="/images/yaml.svg"
# MCP Server
servers:
  benchmark: servers/benchmark
  retriever: servers/retriever
  prompt: servers/prompt
  generation: servers/generation
  evaluation: servers/evaluation
  custom: servers/custom

# MCP Client Pipeline
pipeline:
- benchmark.get_data
- retriever.retriever_init
- retriever.retriever_search
- generation.generation_init
- prompt.qa_rag_boxed
- generation.generate
- custom.output_extract_from_boxed
- evaluation.evaluate
```

æ•´ä¸ªæµç¨‹ä¾æ¬¡å®Œæˆï¼š
1. è¯»å–æ•°æ® â†’ 2. åˆå§‹åŒ–æ£€ç´¢å™¨å¹¶æœç´¢ â†’ 3. å¯åŠ¨ LLM æœåŠ¡ â†’ 4. æ‹¼æ¥ Prompt â†’ 5. ç”Ÿæˆå›ç­” â†’ 6. æå–ç»“æœ â†’ 7. è¯„æµ‹æ€§èƒ½ã€‚

### ç¼–è¯‘ Pipeline æ–‡ä»¶

```shell
ultrarag build examples/rag.yaml
```

### ä¿®æ”¹å‚æ•°æ–‡ä»¶ï¼ˆæŒ‡å®šæ•°æ®é›†ã€æ¨¡å‹ä¸æ£€ç´¢é…ç½®ï¼‰

```yaml examples/parameters/rag_parameter.yaml icon="/images/yaml.svg"
benchmark:
  benchmark:
    key_map:
      gt_ls: golden_answers
      q_ls: question
    limit: -1
    name: nq
    path: data/sample_nq_10.jsonl
    seed: 42
    shuffle: false
custom: {}
evaluation:
  metrics:
  - acc
  - f1
  - em
  - coverem
  - stringem
  - rouge-1
  - rouge-2
  - rouge-l
  save_path: output/evaluate_results.json
generation:
  backend: vllm
  backend_configs:
    hf:
      batch_size: 8
      gpu_ids: 2,3
      model_name_or_path: openbmb/MiniCPM4-8B
      trust_remote_code: true
    openai:
      api_key: ''
      base_delay: 1.0
      base_url: http://localhost:8000/v1
      concurrency: 8
      model_name: MiniCPM4-8B
      retries: 3
    vllm:
      dtype: auto
      gpu_ids: 2,3
      gpu_memory_utilization: 0.9
      model_name_or_path: openbmb/MiniCPM4-8B  # [!code --]
      model_name_or_path: Qwen/Qwen3-8B # [!code ++]
      trust_remote_code: true
  sampling_params:
    chat_template_kwargs:
      enable_thinking: false
    max_tokens: 2048
    temperature: 0.7
    top_p: 0.8
  system_prompt: ''
prompt:
  template: prompt/qa_boxed.jinja # [!code --]
  template: prompt/qa_rag_boxed.jinja  # [!code ++]
retriever:
  backend: sentence_transformers
  backend_configs:
    bm25:
      lang: en
    infinity:
      bettertransformer: false
      device: cuda
      model_warmup: false
      pooling_method: auto
      trust_remote_code: true
    openai:
      api_key: ''
      base_url: https://api.openai.com/v1
      model_name: text-embedding-3-small
    sentence_transformers:
      device: cuda
      sentence_transformers_encode:
        encode_chunk_size: 10000
        normalize_embeddings: false
        psg_prompt_name: document
        psg_task: null
        q_prompt_name: query
        q_task: null
      trust_remote_code: true
  batch_size: 16
  corpus_path: data/corpus_example.jsonl
  faiss_use_gpu: true
  gpu_ids: 0,1
  index_path: index/index.index
  is_multimodal: false
  model_name_or_path: openbmb/MiniCPM-Embedding-Light  # [!code --]
  model_name_or_path: Qwen/Qwen3-Embedding-0.6B  # [!code ++]
  query_instruction: ''
  top_k: 5

```

### è¿è¡ŒPipelineæ–‡ä»¶

```shell
ultrarag run examples/rag.yaml
```

### æŸ¥çœ‹ç”Ÿæˆç»“æœ

ä½¿ç”¨å¯è§†åŒ–è„šæœ¬å¿«é€Ÿæµè§ˆæ¨¡å‹è¾“å‡º

```shell
python ./script/case_study.py \
  --data output/memory_nq_rag_full_20251010_145420.json \
  --host 127.0.0.1 \
  --port 8080 \
  --title "Case Study Viewer"
```
